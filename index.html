<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Utils - C√¥ng c·ª• h·ªó tr·ª£ chatbot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen"></div>

    <script>
        const { createApp, ref, reactive } = Vue;

        const App = {
            setup() {
                // API Configuration - Get from URL query parameters
                // Example URL: ?apiId=YOUR_API_ID&userId=YOUR_USER_ID&username=YOUR_USERNAME
                const urlParams = new URLSearchParams(window.location.search);
                const apiId = urlParams.get('apiId') || localStorage.getItem('apiId');
                const userId = urlParams.get('userId') || localStorage.getItem('userId');
                const username = urlParams.get('username') || 'B·∫°n. B·∫°n kh√¥ng th·ªÉ d√πng ƒë∆∞·ª£c ch·ª©c nƒÉng nh·∫Øc nh·ªü n·∫øu kh√¥ng cung c·∫•p ƒë√∫ng userId v√† apiId';
                
                // State
                const currentPage = ref('menu'); // menu, createReminder, about
                const reminders = ref([]);
                const isLoading = ref(false);
                const isDeleting = ref(false);
                const isCreating = ref(false);
                const errorMessage = ref('');
                const successMessage = ref('');
                const formData = reactive({
                    person: '',
                    content: '',
                    time: '',
                    repeatType: 'no' // no, day, week, month, weekday, weekend
                });
                
                // Constants
                const people = [
                    { name: 'B·∫£n th√¢n', value: 'me' },
                    { name: 'Doha', value: 'ƒë·ªóth·ªãh·∫£i' },
                    { name: 'Leha', value: 'hajaulee' }
                ];
                const repeatTypes = [
                    { value: 'no', label: 'Kh√¥ng l·∫∑p' },
                    { value: 'day', label: 'M·ªói ng√†y' },
                    { value: 'week', label: 'M·ªói tu·∫ßn' },
                    { value: 'month', label: 'M·ªói th√°ng' },
                    { value: 'weekday', label: 'Ng√†y trong tu·∫ßn' },
                    { value: 'weekend', label: 'Cu·ªëi tu·∫ßn' }
                ];

                // Methods
                const goToMenu = () => {
                    currentPage.value = 'menu';
                };

                const goToCreateReminder = () => {
                    currentPage.value = 'createReminder';
                    resetForm();
                    fetchReminders();
                };

                const goToAbout = () => {
                    currentPage.value = 'about';
                };

                const resetForm = () => {
                    formData.person = '';
                    formData.content = '';
                    formData.time = '';
                    formData.repeatType = 'no';
                    successMessage.value = '';
                };

                const fetchReminders = async () => {
                    isLoading.value = true;
                    errorMessage.value = '';
                    try {
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?msg=list_remind&userId=${userId}`;
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Parse messages from API response
                        if (data.messages && Array.isArray(data.messages)) {
                            reminders.value = data.messages.map((message, index) => {
                                const text = message.text || '';
                                // Parse the text to extract information
                                const lines = text.split('\n').filter(line => line.trim());
                                
                                let person = '';
                                let content = '';
                                let time = '';
                                let repeatType = 'none';
                                
                                // Parse each line
                                lines.forEach(line => {
                                    if (line.includes('Ng∆∞·ªùi nh·∫≠n:')) {
                                        person = line.replace('Ng∆∞·ªùi nh·∫≠n:', '').trim();
                                    } else if (line.includes('N·ªôi dung:')) {
                                        content = line.replace('N·ªôi dung:', '').trim();
                                    } else if (line.includes('V√†o l√∫c:')) {
                                        time = line.replace('V√†o l√∫c:', '').trim();
                                    } else if (line.includes('L·∫∑p l·∫°i:')) {
                                        const repeatText = line.replace('L·∫∑p l·∫°i:', '').trim();
                                        if (repeatText.includes('h√†ng ng√†y')) repeatType = 'day';
                                        else if (repeatText.includes('h√†ng tu·∫ßn')) repeatType = 'week';
                                        else if (repeatText.includes('h√†ng th√°ng')) repeatType = 'month';
                                        else repeatType = 'no';
                                    }
                                });
                                
                                return {
                                    id: index,
                                    person: person || '',
                                    content: content || '',
                                    time: time || '',
                                    repeatType: repeatType,
                                    rawText: text,
                                    createdAt: new Date().toLocaleString('vi-VN')
                                };
                            });
                        } else {
                            reminders.value = [];
                        }
                    } catch (error) {
                        console.error('L·ªói khi l·∫•y danh s√°ch nh·∫Øc nh·ªü:', error);
                        errorMessage.value = 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh·∫Øc nh·ªü. Vui l√≤ng th·ª≠ l·∫°i.';
                        reminders.value = [];
                    } finally {
                        isLoading.value = false;
                    }
                };

                const createReminder = async () => {
                    if (!formData.person || !formData.content || !formData.time) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                        return;
                    }
                    
                    try {
                        isCreating.value = true;
                        successMessage.value = '';
                        
                        // Format datetime: 2025-11-16 17:00
                        const datetimeValue = formData.time.replace('T', ' ');
                        
                        // Get repeat label for display
                        const repeatLabel = repeatTypes.find(t => t.value === formData.repeatType)?.label || 'Kh√¥ng l·∫∑p';
                        
                        // Get person name for display
                        const personName = people.find(p => p.value === formData.person)?.name || formData.person;
                        
                        // Call API
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?msg=remind%20${encodeURIComponent(formData.person)}%20${encodeURIComponent(datetimeValue)}%20${encodeURIComponent(formData.content)}%20!repeat%20${formData.repeatType}&userId=${userId}&timezone=9&username=${encodeURIComponent(username)}`;
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('T·∫°o nh·∫Øc nh·ªü th√†nh c√¥ng:', data);
                        
                        // Show confirmation alert
                        alert(`Hihu s·∫Ω nh·∫Øc nh·ªü ${personName}: ${formData.content}\nv√†o l√∫c: ${datetimeValue}\nl·∫∑p l·∫°i: ${repeatLabel}`);
                        
                        // Fetch updated list
                        await fetchReminders();
                        
                        // Reset form
                        resetForm();
                    } catch (error) {
                        console.error('L·ªói khi t·∫°o nh·∫Øc nh·ªü:', error);
                        alert('Kh√¥ng th·ªÉ t·∫°o nh·∫Øc nh·ªü. Vui l√≤ng th·ª≠ l·∫°i.');
                    } finally {
                        isCreating.value = false;
                    }
                };

                const deleteReminder = (id) => {
                    if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a nh·∫Øc nh·ªü n√†y?')) {
                        deleteReminderFromAPI(id);
                    }
                };

                const deleteReminderFromAPI = async (remindIndex) => {
                    try {
                        isDeleting.value = true;
                        // Call API to remove reminder (id is the index)
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?msg=remove_remind%20${remindIndex+1}&userId=${userId}`;
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('X√≥a nh·∫Øc nh·ªü th√†nh c√¥ng:', data);
                        
                        // Fetch updated list
                        await fetchReminders();
                        alert('Nh·∫Øc nh·ªü ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                    } catch (error) {
                        console.error('L·ªói khi x√≥a nh·∫Øc nh·ªü:', error);
                        alert('Kh√¥ng th·ªÉ x√≥a nh·∫Øc nh·ªü. Vui l√≤ng th·ª≠ l·∫°i.');
                    } finally {
                        isDeleting.value = false;
                    }
                };

                // Return reactive properties and methods
                return {
                    apiId,
                    userId,
                    username,
                    currentPage,
                    reminders,
                    isLoading,
                    isDeleting,
                    isCreating,
                    errorMessage,
                    successMessage,
                    formData,
                    people,
                    repeatTypes,
                    goToMenu,
                    goToCreateReminder,
                    goToAbout,
                    resetForm,
                    fetchReminders,
                    createReminder,
                    deleteReminder,
                    deleteReminderFromAPI
                };
            },
            template: /* html */`
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <!-- Loading Overlay (Delete) -->
                    <div v-if="isDeleting" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-2xl p-8 text-center">
                            <div class="flex justify-center mb-4">
                                <div class="relative w-12 h-12">
                                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full animate-spin" style="background-image: conic-gradient(from 0deg, #3b82f6 0deg, #3b82f6 90deg, transparent 90deg); animation: spin 1s linear infinite;"></div>
                                </div>
                            </div>
                            <p class="text-lg font-semibold text-gray-800">ƒêang x√≥a nh·∫Øc nh·ªü...</p>
                            <p class="text-gray-600 text-sm mt-2">Vui l√≤ng ch·ªù, kh√¥ng thao t√°c g√¨ kh√°c</p>
                        </div>
                    </div>

                    <!-- Loading Overlay (Create) -->
                    <div v-if="isCreating" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-2xl p-8 text-center">
                            <div class="flex justify-center mb-4">
                                <div class="relative w-12 h-12">
                                    <div class="absolute inset-0 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full animate-spin" style="background-image: conic-gradient(from 0deg, #10b981 0deg, #10b981 90deg, transparent 90deg); animation: spin 1s linear infinite;"></div>
                                </div>
                            </div>
                            <p class="text-lg font-semibold text-gray-800">ƒêang t·∫°o nh·∫Øc nh·ªü...</p>
                            <p class="text-gray-600 text-sm mt-2">Vui l√≤ng ch·ªù, kh√¥ng thao t√°c g√¨ kh√°c</p>
                        </div>
                    </div>

                    <!-- Header -->
                    <header class="bg-white shadow">
                        <div class="max-w-4xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <h1 class="text-2xl sm:text-3xl font-bold text-indigo-600">ü§ñ Chatbot Utils</h1>
                            <p class="text-gray-600 text-sm">C√¥ng c·ª• h·ªó tr·ª£ qu·∫£n l√Ω chatbot</p>
                            <p class="text-indigo-500 font-semibold mt-2">üëã Xin ch√†o, {{ username }}!</p>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                        <!-- Menu Page -->
                        <div v-if="currentPage === 'menu'" class="space-y-4">
                            <div class="bg-white rounded-lg shadow-lg p-8">
                                <h2 class="text-2xl font-bold text-gray-800 mb-8 text-center">Ch·ªçn ch·ª©c nƒÉng</h2>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Create Reminder Button -->
                                    <button 
                                        @click="goToCreateReminder"
                                        class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg shadow-md transition transform hover:scale-105 active:scale-95"
                                    >
                                        <div class="text-4xl mb-3">üìù</div>
                                        <h3 class="text-xl font-bold">T·∫°o nh·∫Øc nh·ªü</h3>
                                        <p class="text-sm text-blue-100 mt-2">T·∫°o nh·∫Øc nh·ªü cho c√°c th√†nh vi√™n</p>
                                    </button>

                                    <!-- About Button -->
                                    <button 
                                        @click="goToAbout"
                                        class="p-6 bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg shadow-md transition transform hover:scale-105 active:scale-95"
                                    >
                                        <div class="text-4xl mb-3">‚ÑπÔ∏è</div>
                                        <h3 class="text-xl font-bold">Gi·ªõi thi·ªáu</h3>
                                        <p class="text-sm text-purple-100 mt-2">T√¨m hi·ªÉu v·ªÅ ·ª©ng d·ª•ng n√†y</p>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Create Reminder Page -->
                        <div v-if="currentPage === 'createReminder'" class="bg-white rounded-lg shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-8">üìù T·∫°o nh·∫Øc nh·ªü</h2>
                            
                            <!-- Loading Indicator -->
                            <div v-if="isLoading" class="mb-6 p-4 bg-blue-100 border border-blue-300 rounded-lg text-blue-700">
                                ‚è≥ ƒêang t·∫£i danh s√°ch nh·∫Øc nh·ªü...
                            </div>
                            
                            <!-- Error Message -->
                            <div v-if="errorMessage" class="mb-6 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700">
                                ‚ö†Ô∏è {{ errorMessage }}
                            </div>

                            <!-- Reminders List (Above Form) -->
                            <div v-if="reminders.length > 0" class="mb-8 bg-blue-50 rounded-lg p-6 border border-blue-200">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Danh s√°ch nh·∫Øc nh·ªü hi·ªán t·∫°i ({{ reminders.length }})</h3>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    <div 
                                        v-for="(reminder, index) in reminders" 
                                        :key="reminder.id"
                                        class="p-4 border-l-4 border-blue-500 bg-white rounded"
                                    >
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800 text-lg">#{{index + 1}}: üë§ {{ reminder.person }}</p>
                                                <p class="text-gray-700 mt-2">{{ reminder.content }}</p>
                                                <p class="text-sm text-gray-600 mt-2">
                                                    üïê {{ reminder.time }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    üîÑ {{ reminder.repeatType === 'no' ? 'Kh√¥ng l·∫∑p' : reminder.repeatType === 'day' ? 'H√†ng ng√†y' : reminder.repeatType === 'week' ? 'H√†ng tu·∫ßn' : reminder.repeatType === 'month' ? 'H√†ng th√°ng' : reminder.repeatType === 'weekday' ? 'Ng√†y trong tu·∫ßn' : 'Cu·ªëi tu·∫ßn' }}
                                                </p>
                                            </div>
                                            <button 
                                                @click="deleteReminder(reminder.id)"
                                                class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition flex-shrink-0"
                                            >
                                                X√≥a
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Section -->
                            <div class="border-t border-gray-200 pt-8">
                                <h3 class="text-xl font-bold text-gray-800 mb-6">T·∫°o nh·∫Øc nh·ªü m·ªõi</h3>
                            <form @submit.prevent="createReminder" class="space-y-6">
                                <!-- Select Person -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">1. Ch·ªçn ng∆∞·ªùi ƒë·ªÉ nh·∫Øc nh·ªü</label>
                                    <select 
                                        v-model="formData.person"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
                                        <option v-for="person in people" :key="person.value" :value="person.value">
                                            {{ person.name }}
                                        </option>
                                    </select>
                                </div>

                                <!-- Input Content -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">2. Nh·∫≠p n·ªôi dung nh·∫Øc nh·ªü</label>
                                    <textarea 
                                        v-model="formData.content"
                                        placeholder="Nh·∫≠p n·ªôi dung nh·∫Øc nh·ªü..."
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        rows="4"
                                    ></textarea>
                                </div>

                                <!-- Select Time -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">3. Ch·ªçn th·ªùi gian</label>
                                    <input 
                                        v-model="formData.time"
                                        type="datetime-local"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>

                                <!-- Select Repeat Type -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">4. Ch·ªçn ki·ªÉu l·∫∑p l·∫°i</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label 
                                            v-for="type in repeatTypes" 
                                            :key="type.value"
                                            class="flex items-center p-3 border-2 rounded-lg cursor-pointer transition"
                                            :class="formData.repeatType === type.value ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'"
                                        >
                                            <input 
                                                type="radio" 
                                                :value="type.value" 
                                                v-model="formData.repeatType"
                                                class="w-4 h-4"
                                            />
                                            <span class="ml-3 text-gray-700">{{ type.label }}</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-4 pt-6">
                                    <button 
                                        type="submit"
                                        class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition"
                                    >
                                        ‚úì T·∫°o nh·∫Øc nh·ªü
                                    </button>
                                    <button 
                                        type="button"
                                        @click="goToMenu"
                                        class="flex-1 px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition"
                                    >
                                        ‚úï H·ªßy
                                    </button>
                                </div>
                            </form>
                            </div>
                        </div>

                        <!-- About Page -->
                        <div v-if="currentPage === 'about'" class="bg-white rounded-lg shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ÑπÔ∏è Gi·ªõi thi·ªáu</h2>
                            
                            <div class="space-y-4 text-gray-700">
                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">üéØ V·ªÅ ·ª©ng d·ª•ng</h3>
                                    <p>Chatbot Utils l√† ·ª©ng d·ª•ng web h·ªó tr·ª£ qu·∫£n l√Ω c√°c ti·ªán √≠ch cho chatbot, gi√∫p b·∫°n t·∫°o v√† qu·∫£n l√Ω nh·∫Øc nh·ªü d·ªÖ d√†ng.</p>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">‚ú® T√≠nh nƒÉng ch√≠nh</h3>
                                    <ul class="list-disc list-inside space-y-1 ml-2">
                                        <li>üìù T·∫°o nh·∫Øc nh·ªü cho c√°c th√†nh vi√™n</li>
                                        <li>üë§ Ch·ªçn ng∆∞·ªùi nh·∫≠n nh·∫Øc nh·ªü</li>
                                        <li>üïê ƒê·∫∑t th·ªùi gian nh·∫Øc nh·ªü c·ª• th·ªÉ</li>
                                        <li>üîÑ C·∫•u h√¨nh l·∫∑p l·∫°i h√†ng ng√†y, tu·∫ßn, th√°ng</li>
                                        <li>üìã Qu·∫£n l√Ω danh s√°ch nh·∫Øc nh·ªü</li>
                                        <li>üì± Giao di·ªán responsive cho m√°y t√≠nh v√† ƒëi·ªán tho·∫°i</li>
                                    </ul>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">üíª C√¥ng ngh·ªá</h3>
                                    <ul class="list-disc list-inside space-y-1 ml-2">
                                        <li>Vue 3 (Progressive Web App)</li>
                                        <li>Tailwind CSS</li>
                                        <li>JavaScript ES6+</li>
                                    </ul>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">üìå H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
                                    <ol class="list-decimal list-inside space-y-1 ml-2">
                                        <li>Ch·ªçn "T·∫°o nh·∫Øc nh·ªü" t·ª´ menu</li>
                                        <li>Ch·ªçn ng∆∞·ªùi b·∫°n mu·ªën nh·∫Øc nh·ªü</li>
                                        <li>Nh·∫≠p n·ªôi dung nh·∫Øc nh·ªü</li>
                                        <li>Ch·ªçn th·ªùi gian nh·∫Øc nh·ªü</li>
                                        <li>Ch·ªçn ki·ªÉu l·∫∑p l·∫°i (n·∫øu c·∫ßn)</li>
                                        <li>Nh·∫•n "T·∫°o nh·∫Øc nh·ªü" ƒë·ªÉ l∆∞u</li>
                                    </ol>
                                </div>
                            </div>

                            <button 
                                @click="goToMenu"
                                class="mt-8 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition"
                            >
                                ‚Üê Quay l·∫°i Menu
                            </button>
                        </div>
                    </main>

                    <!-- Footer -->
                    <footer class="bg-white border-t border-gray-200 mt-12">
                        <div class="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8 text-center text-gray-600 text-sm">
                            <p>¬© 2025 Chatbot Utils | C√¥ng c·ª• h·ªó tr·ª£ chatbot</p>
                        </div>
                    </footer>
                </div>
            `
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>
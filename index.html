<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Utils - C√¥ng c·ª• h·ªó tr·ª£ chatbot</title>
    <!-- Google Fonts - Roboto Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Local JS -->
     <script src="lunar-solar-converter.js"></script>
    <style>
        .font-mono {
            font-family: 'Roboto Mono', monospace !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen"></div>

    <script>
        /* global lunarToSolar */
        const { createApp, ref, reactive, onMounted } = Vue;

        const App = {
            setup() {
                // API Configuration - Get from URL query parameters
                // Example URL: ?apiId=YOUR_APP_ID&userId=YOUR_USER_ID&username=YOUR_USERNAME
                const urlParams = new URLSearchParams(window.location.search);
                const apiId = urlParams.get('apiId') || localStorage.getItem('apiId');
                const userId = urlParams.get('userId') || localStorage.getItem('userId');
                const username = urlParams.get('username') || 'B·∫°n, B·∫°n kh√¥ng th·ªÉ d√πng ·ª©ng d·ª•ng n√†y n·∫øu kh√¥ng c√≥ th√¥ng tin c·∫•u h√¨nh ƒë√∫ng!';
                const initialPage = urlParams.get('page') || 'menu'; // Default to 'menu' page

                // State
                const currentPage = ref(initialPage); // menu, createReminder, about, family
                const reminders = ref([]);
                const isLoading = ref(false);
                const isDeleting = ref(false);
                const isCreating = ref(false);
                const errorMessage = ref('');
                const successMessage = ref('');
                const formData = reactive({
                    person: '',
                    content: '',
                    time: '',
                    repeatType: 'no' // no, day, week, month, weekday, weekend
                });
                
                // Family Tree State
                const familyPerson = ref('leha');
                const familyText = ref('');
                const familyTree = ref('');
                const isFamilyLoading = ref(false);
                const familyMessage = ref('');
                
                // Lunar Events State
                const lunarEvents = ref([]);
                const lunarEventsInput = ref('');
                const isLunarEventLoading = ref(false);
                const lunarEventMessage = ref('');
                
                // Constants
                const people = [
                    { name: 'B·∫£n th√¢n', value: 'me' },
                    { name: 'Doha', value: 'ƒë·ªóth·ªãh·∫£i' },
                    { name: 'Leha', value: 'hajaulee' }
                ];
                const repeatTypes = [
                    { value: 'no', label: 'Kh√¥ng l·∫∑p' },
                    { value: 'day', label: 'M·ªói ng√†y' },
                    { value: 'week', label: 'M·ªói tu·∫ßn' },
                    { value: 'month', label: 'M·ªói th√°ng' },
                    { value: 'weekday', label: 'Ng√†y trong tu·∫ßn' },
                    { value: 'weekend', label: 'Cu·ªëi tu·∫ßn' }
                ];

                // Cache Helper Functions - Using URL query as cache key
                const getCacheData = (apiUrl) => {
                    try {
                        const url = new URL(apiUrl);
                        const cacheKey = `botui_cache_${url.search}`;
                        const data = localStorage.getItem(cacheKey);
                        return data ? JSON.parse(data) : null;
                    } catch (error) {
                        console.error('L·ªói khi ƒë·ªçc cache:', error);
                        return null;
                    }
                };

                const setCacheData = (apiUrl, data) => {
                    try {
                        const url = new URL(apiUrl);
                        const cacheKey = `botui_cache_${url.search}`;
                        localStorage.setItem(cacheKey, JSON.stringify(data));
                    } catch (error) {
                        console.error('L·ªói khi ghi cache:', error);
                    }
                };

                // Lifecycle Hooks
                onMounted(() => {
                    const initialPageMap = {
                        'menu': goToMenu,
                        'createReminder': goToCreateReminder,
                        'about': goToAbout,
                        'family': goToFamily,
                        'lunarEvents': goToLunarEvents
                    }
                    if (initialPageMap[initialPage]) {
                        initialPageMap[initialPage]();
                    } else {
                        goToMenu();
                    }
                });

                // Methods
                const goToMenu = () => {
                    currentPage.value = 'menu';
                };

                const goToCreateReminder = () => {
                    currentPage.value = 'createReminder';
                    resetForm();
                    fetchReminders();
                };

                const goToAbout = () => {
                    currentPage.value = 'about';
                };

                const goToFamily = () => {
                    currentPage.value = 'family';
                    loadFamilyTree();
                };
                const goToLunarEvents = () => {
                    currentPage.value = 'lunarEvents';
                    loadLunarEvents();
                };

                const resetForm = () => {
                    formData.person = '';
                    formData.content = '';
                    formData.time = '';
                    formData.repeatType = 'no';
                    successMessage.value = '';
                };

                const fetchReminders = async () => {
                    isLoading.value = true;
                    errorMessage.value = '';
                    
                    const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?msg=list_remind&userId=${userId}`;
                    
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ cache tr∆∞·ªõc
                    const cachedReminders = getCacheData(apiUrl);
                    if (cachedReminders) {
                        reminders.value = cachedReminders;
                    }
                    
                    try {
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Parse messages from API response
                        if (data.messages && Array.isArray(data.messages)) {
                            // Check if the only message is the "no reminders" message
                            if (data.messages.length === 1 && data.messages[0].text.includes('B·∫°n ch∆∞a c√≥ nh·∫Øc nh·ªü n√†o')) {
                                reminders.value = [];
                            } else {
                                reminders.value = data.messages.map((message, index) => {
                                    const text = message.text || '';
                                    // Parse the text to extract information
                                    const lines = text.split('\n').filter(line => line.trim());
                                    
                                    let person = '';
                                    let content = '';
                                    let time = '';
                                    let repeatType = 'no';
                                    
                                    // Parse each line
                                    lines.forEach(line => {
                                        if (line.includes('Ng∆∞·ªùi nh·∫≠n:')) {
                                            person = line.replace('Ng∆∞·ªùi nh·∫≠n:', '').trim();
                                        } else if (line.includes('N·ªôi dung:')) {
                                            content = line.replace('N·ªôi dung:', '').trim();
                                        } else if (line.includes('V√†o l√∫c:')) {
                                            time = line.replace('V√†o l√∫c:', '').trim();
                                        } else if (line.includes('L·∫∑p l·∫°i:')) {
                                            const repeatText = line.replace('L·∫∑p l·∫°i:', '').trim();
                                            if (repeatText.includes('h√†ng ng√†y')) repeatType = 'day';
                                            else if (repeatText.includes('h√†ng tu·∫ßn')) repeatType = 'week';
                                            else if (repeatText.includes('h√†ng th√°ng')) repeatType = 'month';
                                            else repeatType = 'no';
                                        }
                                    });
                                    
                                    return {
                                        id: index,
                                        person: person || '',
                                        content: content || '',
                                        time: time || '',
                                        repeatType: repeatType,
                                        rawText: text,
                                        createdAt: new Date().toLocaleString('vi-VN')
                                    };
                                });
                            }
                        } else {
                            reminders.value = [];
                        }
                        // L∆∞u v√†o cache
                        setCacheData(apiUrl, reminders.value);
                    } catch (error) {
                        console.error('L·ªói khi l·∫•y danh s√°ch nh·∫Øc nh·ªü:', error);
                        errorMessage.value = 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh·∫Øc nh·ªü. Vui l√≤ng th·ª≠ l·∫°i.';
                        reminders.value = [];
                    } finally {
                        isLoading.value = false;
                    }
                };

                const createReminder = async () => {
                    if (!formData.person || !formData.content || !formData.time) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                        return;
                    }
                    
                    try {
                        isCreating.value = true;
                        successMessage.value = '';
                        
                        // Format datetime: 2025-11-16 17:00
                        const datetimeValue = formData.time.replace('T', ' ');
                        
                        // Get repeat label for display
                        const repeatLabel = repeatTypes.find(t => t.value === formData.repeatType)?.label || 'Kh√¥ng l·∫∑p';
                        
                        // Get person name for display
                        const personName = people.find(p => p.value === formData.person)?.name || formData.person;
                        
                        // Call API
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?msg=remind%20${encodeURIComponent(formData.person)}%20${encodeURIComponent(datetimeValue)}%20${encodeURIComponent(formData.content)}%20!repeat%20${formData.repeatType}&userId=${userId}&timezone=9&username=${encodeURIComponent(username)}`;
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('T·∫°o nh·∫Øc nh·ªü th√†nh c√¥ng:', data);
                        
                        // Show confirmation alert
                        alert(`Hihu s·∫Ω nh·∫Øc nh·ªü ${personName}: ${formData.content}\nv√†o l√∫c: ${datetimeValue}\nl·∫∑p l·∫°i: ${repeatLabel}`);
                        
                        // Fetch updated list
                        await fetchReminders();
                        
                        // Reset form
                        resetForm();
                    } catch (error) {
                        console.error('L·ªói khi t·∫°o nh·∫Øc nh·ªü:', error);
                        alert('Kh√¥ng th·ªÉ t·∫°o nh·∫Øc nh·ªü. Vui l√≤ng th·ª≠ l·∫°i.');
                    } finally {
                        isCreating.value = false;
                    }
                };

                const deleteReminder = (id) => {
                    if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a nh·∫Øc nh·ªü n√†y?')) {
                        deleteReminderFromAPI(id);
                    }
                };

                const deleteReminderFromAPI = async (remindIndex) => {
                    try {
                        isDeleting.value = true;
                        // Call API to remove reminder (id is the index)
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?msg=remove_remind%20${remindIndex+1}&userId=${userId}`;
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('X√≥a nh·∫Øc nh·ªü th√†nh c√¥ng:', data);
                        
                        // Fetch updated list
                        await fetchReminders();
                        alert('Nh·∫Øc nh·ªü ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                    } catch (error) {
                        console.error('L·ªói khi x√≥a nh·∫Øc nh·ªü:', error);
                        alert('Kh√¥ng th·ªÉ x√≥a nh·∫Øc nh·ªü. Vui l√≤ng th·ª≠ l·∫°i.');
                    } finally {
                        isDeleting.value = false;
                    }
                };

                const loadFamilyTree = async () => {
                    try {
                        isFamilyLoading.value = true;
                        familyMessage.value = '';
                        
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?target=family&action=load&username=${encodeURIComponent(familyPerson.value)}`;
                        
                        // Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ cache tr∆∞·ªõc
                        const cachedFamilyTree = getCacheData(apiUrl);
                        if (cachedFamilyTree) {
                            familyText.value = cachedFamilyTree;
                            parseAndRenderFamilyTree();
                        }
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Ki·ªÉm tra response
                        if (data.content) {
                            familyText.value = data.content;
                            parseAndRenderFamilyTree();
                            familyMessage.value = 'T·∫£i c√¢y gia ph·∫£ th√†nh c√¥ng!';
                            // L∆∞u v√†o cache
                            setCacheData(apiUrl, data.content);
                            setTimeout(() => {
                                familyMessage.value = '';
                            }, 3000);
                        } else if (data.message) {
                            familyMessage.value = data.message;
                        } else {
                            familyText.value = '';
                            familyTree.value = '';
                            familyMessage.value = 'Kh√¥ng c√≥ d·ªØ li·ªáu c√¢y gia ph·∫£ cho ng∆∞·ªùi n√†y';
                        }
                    } catch (error) {
                        console.error('L·ªói khi t·∫£i c√¢y gia ph·∫£:', error);
                        familyMessage.value = 'L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.';
                    } finally {
                        isFamilyLoading.value = false;
                    }
                };

                const saveFamilyTree = async () => {
                    if (!familyText.value.trim()) {
                        alert('Vui l√≤ng nh·∫≠p c√¢y gia ph·∫£ tr∆∞·ªõc khi l∆∞u');
                        return;
                    }

                    try {
                        isFamilyLoading.value = true;
                        familyMessage.value = '';
                        
                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?target=family&action=save&username=${encodeURIComponent(familyPerson.value)}&content=${encodeURIComponent(familyText.value)}`;
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        familyMessage.value = data.message || 'L∆∞u c√¢y gia ph·∫£ th√†nh c√¥ng!';
                        setTimeout(() => {
                            familyMessage.value = '';
                        }, 3000);
                    } catch (error) {
                        console.error('L·ªói khi l∆∞u c√¢y gia ph·∫£:', error);
                        familyMessage.value = 'L·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.';
                    } finally {
                        isFamilyLoading.value = false;
                    }
                };

                const parseAndRenderFamilyTree = () => {
                    if (!familyText.value.trim()) {
                        familyTree.value = '';
                        return;
                    }

                    const lines = familyText.value.split('\n').filter(line => line.trim() !== '');
                    let result = '';
                    const isLastChild = []; // Track if each level's current node is the last child

                    // Helper function to get indentation level
                    const getDepth = (line) => {
                        const match = line.match(/^( *)/);
                        return match ? match[1].length : 0;
                    };

                    // Helper function to check if a node at given index is the last child of its parent
                    const checkIsLastChild = (index, currentDepth) => {
                        // Find the next sibling (same depth or less)
                        for (let i = index + 1; i < lines.length; i++) {
                            const nextDepth = getDepth(lines[i]);
                            if (nextDepth < currentDepth) {
                                // Jumped to a shallower level, so current is last child
                                return true;
                            }
                            if (nextDepth === currentDepth) {
                                // Found next sibling, so current is not last child
                                return false;
                            }
                            // nextDepth > currentDepth, skip this (it's a child)
                        }
                        // No more siblings found, so this is the last child
                        return true;
                    };

                    lines.forEach((line, index) => {
                        const depth = getDepth(line);
                        const text = line.replaceAll("-", "").trimStart();
                        
                        // Build the prefix with tree characters
                        // Last position - check if this is last sibling
                        const isLast = checkIsLastChild(index, depth);
                        // Store whether this node is the last child
                        isLastChild[depth-1] = isLast;
                        let prefix = '';
                        for (let i = 0; i < depth; i++) {
                            if (i === depth - 1) {
                                // Last position - check if this is last sibling
                                prefix += isLast ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
                            } else {
                                // Not last position - use continuation lines
                                // Check if ancestors at level i have more siblings                                
                                const ancestorIsLast = isLastChild[i] != false;
                                prefix += ancestorIsLast ? '    ' : '‚îÇ   ';
                            }
                        }

                        if (depth === 0) {
                            prefix = '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                        }

                        result += prefix + text + '\n';
                    });

                    familyTree.value = result;
                };

                // Lunar Events Methods
                const parseLunarEvents = (text) => {
                    if (!text.trim()) {
                        return [];
                    }

                    const lines = text.split('\n').filter(line => line.trim());
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    return lines.map(line => {
                        const parts = line.split(':').map(p => p.trim());
                        if (parts.length < 2) return null;

                        const dateParts = parts[0].split('/');
                        if (dateParts.length !== 2) return null;

                        const day = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]);
                        const solarDate = lunarToSolar({year: today.getFullYear(), month, day});
                        const eventName = parts[1];

                        // Calculate current year occurrence
                        let eventDate = new Date(today.getFullYear(), solarDate.solarMonth - 1, solarDate.solarDay);

                        let daysLeft = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                        if (daysLeft < -200) {
                            // If event has passed this year, calculate for next year
                            eventDate = new Date(today.getFullYear() + 1, solarDate.solarMonth - 1, solarDate.solarDay);
                            daysLeft = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                        }

                        let daysText = '';
                        if (daysLeft === 0) {
                            daysText = 'H√¥m nay';
                        } else if (daysLeft === 1) {
                            daysText = 'Ng√†y mai';
                        } else if (daysLeft > 1) {
                            daysText = `C√°ch ${daysLeft} ng√†y`;
                        } else {
                            daysText = `ƒê√£ qua ${-daysLeft} ng√†y`;
                        }

                        return {
                            date:  `${day}/${month}`,
                            lunarDate: `${day}/${month}`,
                            solarDate: `${solarDate.solarDay}/${solarDate.solarMonth}`,
                            eventName: eventName,
                            daysLeft: daysLeft,
                            daysText: daysText
                        };
                    }).filter(e => e !== null).sort((a, b) => a.daysLeft - b.daysLeft);
                };

                const loadLunarEvents = async () => {
                    const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?target=lunarEvents&action=load&username=common`;
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ cache tr∆∞·ªõc
                    const cachedLunarEvents = getCacheData(apiUrl);
                    if (cachedLunarEvents) {
                        lunarEventsInput.value = cachedLunarEvents;
                        lunarEvents.value = parseLunarEvents(cachedLunarEvents);
                    }
                    try {
                        isLunarEventLoading.value = true;
                        lunarEventMessage.value = '';

                        
                        const response = await fetch(apiUrl);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        if (data.content) {
                            lunarEventsInput.value = data.content;
                            lunarEvents.value = parseLunarEvents(data.content);
                            setCacheData(apiUrl, data.content);
                        } else {
                            lunarEventsInput.value = '';
                            lunarEvents.value = [];
                        }
                    } catch (error) {
                        console.error('L·ªói khi t·∫£i s·ª± ki·ªán √¢m l·ªãch:', error);
                        lunarEventMessage.value = 'L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.';
                    } finally {
                        isLunarEventLoading.value = false;
                    }
                };

                const saveLunarEvents = async () => {
                    if (!lunarEventsInput.value.trim()) {
                        alert('Vui l√≤ng nh·∫≠p s·ª± ki·ªán');
                        return;
                    }

                    try {
                        isLunarEventLoading.value = true;
                        lunarEventMessage.value = '';

                        const apiUrl = `https://script.google.com/macros/s/${apiId}/exec?target=lunarEvents&action=save&username=common&content=${encodeURIComponent(lunarEventsInput.value)}`;
                        const response = await fetch(apiUrl);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        lunarEvents.value = parseLunarEvents(lunarEventsInput.value);
                        lunarEventMessage.value = data.message || 'L∆∞u s·ª± ki·ªán th√†nh c√¥ng!';
                        setTimeout(() => {
                            lunarEventMessage.value = '';
                        }, 3000);
                    } catch (error) {
                        console.error('L·ªói khi l∆∞u s·ª± ki·ªán √¢m l·ªãch:', error);
                        lunarEventMessage.value = 'L·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.';
                    } finally {
                        isLunarEventLoading.value = false;
                    }
                };

                // Return reactive properties and methods
                return {
                    apiId,
                    userId,
                    username,
                    currentPage,
                    reminders,
                    isLoading,
                    isDeleting,
                    isCreating,
                    errorMessage,
                    successMessage,
                    formData,
                    people,
                    repeatTypes,
                    goToMenu,
                    goToCreateReminder,
                    goToAbout,
                    goToFamily,
                    resetForm,
                    fetchReminders,
                    createReminder,
                    deleteReminder,
                    deleteReminderFromAPI,
                    familyPerson,
                    familyText,
                    familyTree,
                    isFamilyLoading,
                    familyMessage,
                    parseAndRenderFamilyTree,
                    loadFamilyTree,
                    saveFamilyTree,
                    lunarEvents,
                    lunarEventsInput,
                    isLunarEventLoading,
                    lunarEventMessage,
                    goToLunarEvents,
                    loadLunarEvents,
                    saveLunarEvents,
                    parseLunarEvents
                };
            },
            template: /* html */`
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <!-- Loading Overlay (Delete) -->
                    <div v-if="isDeleting" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-2xl p-8 text-center">
                            <div class="flex justify-center mb-4">
                                <div class="relative w-12 h-12">
                                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full animate-spin" style="background-image: conic-gradient(from 0deg, #3b82f6 0deg, #3b82f6 90deg, transparent 90deg); animation: spin 1s linear infinite;"></div>
                                </div>
                            </div>
                            <p class="text-lg font-semibold text-gray-800">ƒêang x√≥a nh·∫Øc nh·ªü...</p>
                            <p class="text-gray-600 text-sm mt-2">Vui l√≤ng ch·ªù, kh√¥ng thao t√°c g√¨ kh√°c</p>
                        </div>
                    </div>

                    <!-- Loading Overlay (Create) -->
                    <div v-if="isCreating" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-2xl p-8 text-center">
                            <div class="flex justify-center mb-4">
                                <div class="relative w-12 h-12">
                                    <div class="absolute inset-0 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full animate-spin" style="background-image: conic-gradient(from 0deg, #10b981 0deg, #10b981 90deg, transparent 90deg); animation: spin 1s linear infinite;"></div>
                                </div>
                            </div>
                            <p class="text-lg font-semibold text-gray-800">ƒêang t·∫°o nh·∫Øc nh·ªü...</p>
                            <p class="text-gray-600 text-sm mt-2">Vui l√≤ng ch·ªù, kh√¥ng thao t√°c g√¨ kh√°c</p>
                        </div>
                    </div>

                    <!-- Header -->
                    <header class="bg-white shadow">
                        <div class="max-w-4xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <h1 class="text-2xl sm:text-3xl font-bold text-indigo-600">ü§ñ Chatbot Utils</h1>
                            <p class="text-gray-600 text-sm">C√¥ng c·ª• h·ªó tr·ª£ qu·∫£n l√Ω chatbot</p>
                            <p class="text-indigo-500 font-semibold mt-2">üëã Xin ch√†o, {{ username }}!</p>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                        <!-- Menu Page -->
                        <div v-if="currentPage === 'menu'" class="space-y-4">
                            <div class="bg-white rounded-lg shadow-lg p-8">
                                <h2 class="text-2xl font-bold text-gray-800 mb-8 text-center">Ch·ªçn ch·ª©c nƒÉng</h2>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <!-- Create Reminder Button -->
                                    <button 
                                        @click="goToCreateReminder"
                                        class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg shadow-md transition transform hover:scale-105 active:scale-95"
                                    >
                                        <div class="text-4xl mb-3">üìù</div>
                                        <h3 class="text-xl font-bold">T·∫°o nh·∫Øc nh·ªü</h3>
                                        <p class="text-sm text-blue-100 mt-2">T·∫°o nh·∫Øc nh·ªü cho c√°c th√†nh vi√™n</p>
                                    </button>

                                    <!-- Family Tree Button -->
                                    <button 
                                        @click="goToFamily"
                                        class="p-6 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg shadow-md transition transform hover:scale-105 active:scale-95"
                                    >
                                        <div class="text-4xl mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                                        <h3 class="text-xl font-bold">H·ªç h√†ng</h3>
                                        <p class="text-sm text-green-100 mt-2">Xem c√¢y gia ph·∫£</p>
                                    </button>

                                    <!-- Lunar Events Button -->
                                    <button 
                                        @click="goToLunarEvents"
                                        class="p-6 bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-lg shadow-md transition transform hover:scale-105 active:scale-95"
                                    >
                                        <div class="text-4xl mb-3">üìÖ</div>
                                        <h3 class="text-xl font-bold">S·ª± ki·ªán √¢m l·ªãch</h3>
                                        <p class="text-sm text-orange-100 mt-2">Qu·∫£n l√Ω s·ª± ki·ªán √¢m l·ªãch quan tr·ªçng</p>
                                    </button>

                                    <!-- About Button -->
                                    <button 
                                        @click="goToAbout"
                                        class="p-6 bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg shadow-md transition transform hover:scale-105 active:scale-95"
                                    >
                                        <div class="text-4xl mb-3">‚ÑπÔ∏è</div>
                                        <h3 class="text-xl font-bold">Gi·ªõi thi·ªáu</h3>
                                        <p class="text-sm text-purple-100 mt-2">T√¨m hi·ªÉu v·ªÅ ·ª©ng d·ª•ng n√†y</p>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Create Reminder Page -->
                        <div v-if="currentPage === 'createReminder'" class="bg-white rounded-lg shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-8">üìù T·∫°o nh·∫Øc nh·ªü</h2>
                            
                            <!-- Loading Indicator -->
                            <div v-if="isLoading" class="mb-6 p-4 bg-blue-100 border border-blue-300 rounded-lg text-blue-700">
                                ‚è≥ ƒêang t·∫£i danh s√°ch nh·∫Øc nh·ªü...
                            </div>
                            
                            <!-- Error Message -->
                            <div v-if="errorMessage" class="mb-6 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700">
                                ‚ö†Ô∏è {{ errorMessage }}
                            </div>

                            <!-- Empty State Message -->
                            <div v-if="!isLoading && reminders.length === 0" class="mb-8 bg-yellow-50 rounded-lg p-6 border border-yellow-200">
                                <p class="text-center text-yellow-700 text-lg">
                                    üì≠ B·∫°n ch∆∞a c√≥ nh·∫Øc nh·ªü n√†o!
                                </p>
                                <p class="text-center text-yellow-600 text-sm mt-2">
                                    H√£y t·∫°o nh·∫Øc nh·ªü m·ªõi b√™n d∆∞·ªõi
                                </p>
                            </div>

                            <!-- Reminders List (Above Form) -->
                            <div v-if="reminders.length > 0" class="mb-8 bg-blue-50 rounded-lg p-6 border border-blue-200">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Danh s√°ch nh·∫Øc nh·ªü hi·ªán t·∫°i ({{ reminders.length }})</h3>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    <div 
                                        v-for="(reminder, index) in reminders" 
                                        :key="reminder.id"
                                        class="p-4 border-l-4 border-blue-500 bg-white rounded"
                                    >
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800 text-lg">#{{index + 1}}: üë§ {{ reminder.person }}</p>
                                                <p class="text-gray-700 mt-2">{{ reminder.content }}</p>
                                                <p class="text-sm text-gray-600 mt-2">
                                                    üïê {{ reminder.time }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    üîÑ {{ reminder.repeatType === 'no' ? 'Kh√¥ng l·∫∑p' : reminder.repeatType === 'day' ? 'H√†ng ng√†y' : reminder.repeatType === 'week' ? 'H√†ng tu·∫ßn' : reminder.repeatType === 'month' ? 'H√†ng th√°ng' : reminder.repeatType === 'weekday' ? 'Ng√†y trong tu·∫ßn' : 'Cu·ªëi tu·∫ßn' }}
                                                </p>
                                            </div>
                                            <button 
                                                @click="deleteReminder(reminder.id)"
                                                class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition flex-shrink-0"
                                            >
                                                X√≥a
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Section -->
                            <div class="border-t border-gray-200 pt-8">
                                <h3 class="text-xl font-bold text-gray-800 mb-6">T·∫°o nh·∫Øc nh·ªü m·ªõi</h3>
                            <form @submit.prevent="createReminder" class="space-y-6">
                                <!-- Select Person -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">1. Ch·ªçn ng∆∞·ªùi ƒë·ªÉ nh·∫Øc nh·ªü</label>
                                    <select 
                                        v-model="formData.person"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
                                        <option v-for="person in people" :key="person.value" :value="person.value">
                                            {{ person.name }}
                                        </option>
                                    </select>
                                </div>

                                <!-- Input Content -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">2. Nh·∫≠p n·ªôi dung nh·∫Øc nh·ªü</label>
                                    <textarea 
                                        v-model="formData.content"
                                        placeholder="Nh·∫≠p n·ªôi dung nh·∫Øc nh·ªü..."
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        rows="4"
                                    ></textarea>
                                </div>

                                <!-- Select Time -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">3. Ch·ªçn th·ªùi gian</label>
                                    <input 
                                        v-model="formData.time"
                                        type="datetime-local"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>

                                <!-- Select Repeat Type -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">4. Ch·ªçn ki·ªÉu l·∫∑p l·∫°i</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label 
                                            v-for="type in repeatTypes" 
                                            :key="type.value"
                                            class="flex items-center p-3 border-2 rounded-lg cursor-pointer transition"
                                            :class="formData.repeatType === type.value ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'"
                                        >
                                            <input 
                                                type="radio" 
                                                :value="type.value" 
                                                v-model="formData.repeatType"
                                                class="w-4 h-4"
                                            />
                                            <span class="ml-3 text-gray-700">{{ type.label }}</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-4 pt-6">
                                    <button 
                                        type="submit"
                                        class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition"
                                    >
                                        ‚úì T·∫°o nh·∫Øc nh·ªü
                                    </button>
                                    <button 
                                        type="button"
                                        @click="goToMenu"
                                        class="flex-1 px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition"
                                    >
                                        ‚úï H·ªßy
                                    </button>
                                </div>
                            </form>
                            </div>
                        </div>

                        <!-- About Page -->
                        <div v-if="currentPage === 'about'" class="bg-white rounded-lg shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ÑπÔ∏è Gi·ªõi thi·ªáu</h2>
                            
                            <div class="space-y-4 text-gray-700">
                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">üéØ V·ªÅ ·ª©ng d·ª•ng</h3>
                                    <p>Chatbot Utils l√† ·ª©ng d·ª•ng Progressive Web App (PWA) h·ªó tr·ª£ qu·∫£n l√Ω c√°c ti·ªán √≠ch cho chatbot. ·ª®ng d·ª•ng gi√∫p b·∫°n t·∫°o v√† qu·∫£n l√Ω nh·∫Øc nh·ªü, c√¢y gia ph·∫£, v√† s·ª± ki·ªán √¢m l·ªãch d·ªÖ d√†ng.</p>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">‚ú® T√≠nh nƒÉng ch√≠nh</h3>
                                    <ul class="list-disc list-inside space-y-2 ml-2">
                                        <li><strong>üìù T·∫°o nh·∫Øc nh·ªü</strong> - T·∫°o nh·∫Øc nh·ªü cho c√°c th√†nh vi√™n v·ªõi l·∫∑p l·∫°i (ng√†y, tu·∫ßn, th√°ng)</li>
                                        <li><strong>ÔøΩ‚Äçüë©‚Äçüëß‚Äçüë¶ Qu·∫£n l√Ω c√¢y gia ph·∫£</strong> - Nh·∫≠p v√† hi·ªÉn th·ªã c√¢y gia ph·∫£ d·∫°ng ASCII ƒë·∫πp m·∫Øt</li>
                                        <li><strong>ÔøΩ S·ª± ki·ªán √¢m l·ªãch</strong> - Qu·∫£n l√Ω s·ª± ki·ªán √¢m l·ªãch v·ªõi t√≠nh to√°n ng√†y kho·∫£ng c√°ch ƒë·ªông</li>
                                        <li><strong>ÔøΩ Cache th√¥ng minh</strong> - L·∫•y d·ªØ li·ªáu t·ª´ cache ngay, c·∫≠p nh·∫≠t t·ª´ API ·ªü background</li>
                                        <li><strong>ÔøΩ Responsive design</strong> - Ho·∫°t ƒë·ªông t·ªët tr√™n m√°y t√≠nh, tablet, ƒëi·ªán tho·∫°i</li>
                                        <li><strong>‚ö° Hi·ªáu su·∫•t cao</strong> - Loading overlay, UX m∆∞·ª£t m√†, font ƒë√∫ng</li>
                                    </ul>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">üíª C√¥ng ngh·ªá</h3>
                                    <ul class="list-disc list-inside space-y-1 ml-2">
                                        <li>Vue 3 (Composition API, CDN)</li>
                                        <li>Tailwind CSS (CDN)</li>
                                        <li>Roboto Mono (Google Fonts)</li>
                                        <li>JavaScript ES6+</li>
                                        <li>localStorage API (cache)</li>
                                        <li>Fetch API (API calls)</li>
                                    </ul>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600 mb-2">üìå H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
                                    <ol class="list-decimal list-inside space-y-2 ml-2">
                                        <li><strong>T·∫°o nh·∫Øc nh·ªü</strong>: Ch·ªçn "üìù T·∫°o nh·∫Øc nh·ªü" ‚Üí ƒêi·ªÅn th√¥ng tin ‚Üí L∆∞u</li>
                                        <li><strong>C√¢y gia ph·∫£</strong>: Ch·ªçn "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ H·ªç h√†ng" ‚Üí Ch·ªçn ng∆∞·ªùi ‚Üí Nh·∫≠p c√¢y ‚Üí L∆∞u</li>
                                        <li><strong>S·ª± ki·ªán √¢m l·ªãch</strong>: Ch·ªçn "üìÖ S·ª± ki·ªán √¢m l·ªãch" ‚Üí Nh·∫≠p s·ª± ki·ªán (ng√†y/th√°ng: t√™n) ‚Üí L∆∞u</li>
                                        <li><strong>Quay l·∫°i</strong>: D√πng n√∫t "‚Üê Quay l·∫°i Menu" ho·∫∑c logo ƒë·ªÉ quay v·ªÅ menu ch√≠nh</li>
                                    </ol>
                                </div>
                            </div>

                            <button 
                                @click="goToMenu"
                                class="mt-8 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition"
                            >
                                ‚Üê Quay l·∫°i Menu
                            </button>
                        </div>

                        <!-- Lunar Events Page -->
                        <div v-if="currentPage === 'lunarEvents'" class="bg-white rounded-lg shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìÖ S·ª± ki·ªán √¢m l·ªãch</h2>
                            
                            <!-- Lunar Events Message -->
                            <div v-if="lunarEventMessage" class="mb-6 p-4 rounded-lg" :class="lunarEventMessage.includes('L·ªói') ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'">
                                {{ lunarEventMessage }}
                            </div>

                            <!-- Lunar Events List -->
                            <div v-if="lunarEvents.length > 0" class="mb-8">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Danh s√°ch s·ª± ki·ªán √¢m l·ªãch</h3>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    <div 
                                        v-for="(event, index) in lunarEvents"
                                        :key="index"
                                        class="p-4 border-l-4 border-orange-500 bg-orange-50 rounded flex justify-between items-start"
                                    >
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-lg">{{ event.eventName }}</p>
                                            <p class="text-sm text-gray-600 mt-2">üìÖ {{ event.date }} √¢m l·ªãch, t·ª©c {{ event.solarDate }} d∆∞∆°ng l·ªãch</p>
                                            <p class="text-sm font-semibold text-orange-600 mt-1">
                                                {{ event.daysText }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div v-if="lunarEvents.length === 0 && lunarEventsInput.trim() === ''" class="mb-8 bg-blue-50 rounded-lg p-6 border border-blue-200">
                                <p class="text-center text-blue-700">üìù Nh·∫≠p d·ªØ li·ªáu ·ªü d∆∞·ªõi ƒë·ªÉ xem danh s√°ch s·ª± ki·ªán √¢m l·ªãch</p>
                            </div>

                            <!-- Lunar Events Input -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nh·∫≠p s·ª± ki·ªán √¢m l·ªãch (ƒë·ªãnh d·∫°ng: ng√†y/th√°ng: t√™n s·ª± ki·ªán)</label>
                                <textarea 
                                    v-model="lunarEventsInput"
                                    @input="lunarEvents = parseLunarEvents(lunarEventsInput)"
                                    placeholder="V√≠ d·ª•:&#10;8/8: Gi·ªó √¥ng A&#10;12/3: Gi·ªó √¥ng B"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-vertical font-mono"
                                    rows="6"
                                ></textarea>
                                <p class="text-xs text-gray-500 mt-2">üí° M·ªói d√≤ng m·ªôt s·ª± ki·ªán, ƒë·ªãnh d·∫°ng: ng√†y/th√°ng: t√™n s·ª± ki·ªán (√¢m l·ªãch)</p>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-4">
                                <button 
                                    @click="saveLunarEvents"
                                    :disabled="isLunarEventLoading || !lunarEventsInput.trim()"
                                    class="flex-1 px-6 py-3 bg-orange-500 hover:bg-orange-600 disabled:bg-gray-400 text-white font-semibold rounded-lg transition"
                                >
                                    {{ isLunarEventLoading ? 'ƒêang l∆∞u...' : 'üíæ L∆∞u s·ª± ki·ªán √¢m l·ªãch' }}
                                </button>
                                <button 
                                    @click="goToMenu"
                                    class="flex-1 px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition"
                                >
                                    ‚Üê Quay l·∫°i Menu
                                </button>
                            </div>
                        </div>

                        <!-- Family Tree Page -->
                        <div v-if="currentPage === 'family'" class="bg-white rounded-lg shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ C√¢y gia ph·∫£</h2>
                            
                            <!-- Select Family Person -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ch·ªçn ng∆∞·ªùi</label>
                                <select 
                                    v-model="familyPerson"
                                    @change="loadFamilyTree"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                >
                                    <option value="doha">Doha</option>
                                    <option value="leha">Leha</option>
                                </select>
                            </div>

                            <!-- Family Message -->
                            <div v-if="familyMessage" class="mb-6 p-4 rounded-lg" :class="familyMessage.includes('L·ªói') ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'">
                                {{ familyMessage }}
                            </div>

                            <!-- Family Tree Display -->
                            <div v-if="familyTree" class="mb-6 bg-gray-50 rounded-lg p-6 border border-gray-200 overflow-x-auto">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">üå≥ C√¢y gia ph·∫£ hi·ªÉn th·ªã</h3>
                                <pre class="text-gray-700 text-sm font-mono whitespace-pre">{{ familyTree }}</pre>
                            </div>

                            <!-- Empty State -->
                            <div v-if="!familyTree && familyText.trim() === ''" class="mb-6 bg-blue-50 rounded-lg p-6 border border-blue-200">
                                <p class="text-center text-blue-700">ÔøΩ Nh·∫≠p d·ªØ li·ªáu ·ªü tr√™n ƒë·ªÉ xem c√¢y gia ph·∫£</p>
                            </div>

                            <!-- Family Text Input -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nh·∫≠p c√¢y gia ph·∫£ (d√πng d·∫•u c√°ch ƒë·ªÉ th·ª•t l·ªÅ)</label>
                                <textarea 
                                    v-model="familyText"
                                    @input="parseAndRenderFamilyTree"
                                    placeholder="V√≠ d·ª•:&#10;N·ªôi&#10; - c√¥ A x b√°c B&#10;  - ch·ªã X&#10;   - X1&#10;   - X2&#10;  - ch·ªã Y"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-vertical font-mono"
                                    rows="6"
                                ></textarea>
                                <p class="text-xs text-gray-500 mt-2">ÔøΩ D√πng d·∫•u c√°ch ·ªü ƒë·∫ßu d√≤ng ƒë·ªÉ t·∫°o c·∫•p ƒë·ªô (m·ªói d·∫•u c√°ch = 1 c·∫•p)</p>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-4">
                                <button 
                                    @click="saveFamilyTree"
                                    :disabled="isFamilyLoading || !familyText.trim()"
                                    class="flex-1 px-6 py-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-semibold rounded-lg transition"
                                >
                                    {{ isFamilyLoading ? 'ƒêang l∆∞u...' : 'üíæ L∆∞u c√¢y gia ph·∫£' }}
                                </button>
                                <button 
                                    @click="goToMenu"
                                    class="flex-1 px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition"
                                >
                                    ‚Üê Quay l·∫°i Menu
                                </button>
                            </div>
                        </div>
                    </main>

                    <!-- Footer -->
                    <footer class="bg-white border-t border-gray-200 mt-12">
                        <div class="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8 text-center text-gray-600 text-sm">
                            <p>¬© 2025 Chatbot Utils | C√¥ng c·ª• h·ªó tr·ª£ chatbot</p>
                        </div>
                    </footer>
                </div>
            `
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>